<script>

Array.prototype.remove = function(element)
{
	var index = this.indexOf(element);
	if (index != -1)
		this.splice(index, 1);
}

function HitList()
{
	this.items = {}
}

HitList.prototype.push = function(item)
{
	if (item in this.items)
		this.items[item]++;
	else
		this.items[item] = 1;
}

function URL(url)
{
	this.parse(url);
}

URL.prototype.pattern = /^([^:]+):\/\/([^\/]+)\/?/;

URL.prototype.domainPattern = /([^.]+\.[^.]+)$/;

URL.prototype.parse = function(url)
{
	if (!(m = url.match(this.pattern)))
		return false;
	
	this.url = url;
	this.protocol = m[1];
	this.hostname = m[2];
	
	if (m = this.hostname.match(this.domainPattern))
		this.domain = m[1];
	else
		this.domain = this.hostname;
}

function Site(url)
{
	this.protocol = url.protocol;
	this.domain = url.domain;
	
	this.requests = new HitList();
	this.requested_by = new HitList();
}

Site.prototype.toString = function()
{
	return this.domain;
}

var $sites = {};

var $listeners = [];

function getURLOfTab(tabId, callback)
{
	chrome.tabs.get(tabId, function(tab) {
		if (tab)
			callback(tab.url);
	});
}

function getSiteOfTab(tabId, callback)
{
	getURLOfTab(tabId, function(url) {
		getSiteOfURL(url, callback);
	});
}

function getSiteOfURL(href, callback)
{
	var url = new URL(href);
	
	if (url.domain in $sites === false)
		$sites[url.domain] = new Site(url);
	
	callback($sites[url.domain]);
}

function getHeader(name, headers)
{
	for (var i = 0; i < headers.length; ++i)
		if (headers[i].name == name)
			return headers[i].value;
	
	return null;
}

function notifyListeners(requesting_site, requested_site)
{
	$listeners.forEach(function(listener) {
		listener.postMessage({
			event: 'request',
			requesting_site: requesting_site,
			requested_site: requested_site
		});
	})
}

/*
chrome.experimental.webRequest.onBeforeRequest.addListener(function(request) {
	if (request.tabId == -1) {
		console.log('Tab unrelated request to', request.url);
		return;
	}
	
	getSiteOfTab(request.tabId, function(requesting_site) {
		getSiteOfURL(request.url, function(requested_site) {
			requesting_site.requests.push(requested_site);
			requested_site.requested_by.push(requesting_site);
			notifyListeners(requesting_site, requested_site);
		});
	});
}, {
	types: ["sub_frame", "stylesheet", "script", "image", "object", "other"]
});
*/

chrome.experimental.webRequest.onSendHeaders.addListener(
	function(request) {
		var referrer = getHeader("Referer", request.requestHeaders);
		
		if (!referrer) {
			console.log("No referrer for", request.url, request.requestHeaders);
			return;
		}
		
		getSiteOfURL(referrer, function(requesting_site) {
			getSiteOfURL(request.url, function(requested_site) {
				requesting_site.requests.push(requested_site);
				requested_site.requested_by.push(requesting_site);
				notifyListeners(requesting_site, requested_site);
			});
		});
	},
	{
		types: ["sub_frame", "stylesheet", "script", "image", "object"]
	},
	["requestHeaders"]
);

chrome.browserAction.onClicked.addListener(function(tab) {
	var graph_url = chrome.extension.getURL('graph.html');
	chrome.tabs.create({url: graph_url});
});

chrome.extension.onConnect.addListener(function(port) {
	$listeners.push(port);
	
	port.onDisconnect.addListener(function() {
		$listeners.remove(port);
	});
});

chrome.extension.onRequest.addListener(function(request, sender, respond) {
	console.log("Received request", request);

	if (!request.action)
		return;
	
	switch (request.action) {
		 case 'get_sites':
		 	console.log('responding with', $sites);
		 	respond($sites);
		 	break;
	}
});

</script>