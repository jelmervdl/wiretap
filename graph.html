<!DOCTYPE>
<html>
	<head>
		<title>Wiretap</title>
		<script src="lib/d3/d3.js"></script>
		<script src="lib/d3/d3.geom.js"></script>
		<script src="lib/d3/d3.layout.js"></script>
		<style>

		body {
			margin: 0;
			padding: 0;
		}

		#info {
			position: absolute;
			top: 0;
			right: 0;
		}

		rect {
		  fill: #fff;
		}

		.node circle {
			stroke: #333;
			fill: #ccc;
		}
		
		.link {
		  stroke: #999;
		}

		    </style>
	</head>
	<body>
		<div id="chart"></div>
		<p id="info"></p>
		<script>
			var w = 960,
				h = 500,
				fill = d3.scale.category20(),
				sites = {},
				nodes = [],
				links = [];

			var vis = d3.select("#chart").append("svg:svg");

			vis.append("svg:rect")
				.attr("width", "100%")
				.attr("height", "100%");

			var force = d3.layout.force()
				.linkDistance(function(l) {
					return Math.max(
						120 - l.target.site.requested_by.items[l.source.site.domain] / sum(l.target.site.requested_by.items) * 100,
						3 + radius(l.source) + radius(l.target)
					)
				})
				//.linkStrength(function(l) { return l.target.site.requested_by.items[l.source.site.domain] / sum(l.target.site.requested_by.items); })
				.charge(-200)
				//
				//.friction(function(d) { return radius(d, 1, 30) / 30 })
				.nodes(nodes)
				.links(links);

			force.on("tick", function() {
				vis.selectAll("line.link")
					.attr("x1", function(d) { return d.source.x; })
					.attr("y1", function(d) { return d.source.y; })
					.attr("x2", function(d) { return d.target.x; })
					.attr("y2", function(d) { return d.target.y; });

				vis.selectAll("g.node")
					.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
				
				vis.selectAll("g.node circle")
					.attr("r", function(d) { return radius(d); });
			});
			
			function addSite(site, origin)
			{
				if (!sites[site.domain])
					sites[site.domain] = site;
				
				else if (sites[site.domain].node)
					return;
				
			 	var node = {x: origin ? origin.node.x : 10, y: origin ? origin.node.y : 10, site: sites[site.domain]};
				sites[site.domain].node = node;
				nodes.push(node);
			}
			
			function addLink(requesting_domain, requested_domain)
			{
				if (sites[requesting_domain].node === undefined)
					throw Error("Cannot create link: requesting domain " + requesting_domain + " is missing a node");
				
				if (sites[requested_domain].node === undefined)
					throw Error("Cannot create link: requested domain " + requested_domain + " is missing a node");
				
				links.push({
					source: sites[requesting_domain].node,
					target: sites[requested_domain].node
				});
			}
			
			function isLinked(requesting_domain, requested_domain)
			{
				if (sites[requesting_domain].node === undefined
					|| sites[requested_domain].node === undefined)
					return false;
				
				var link = {
					source: sites[requesting_domain].node,
					target: sites[requested_domain].node
				}
				
				return links.indexOf(link) !== -1;
			}

			function resize()
			{
				w = document.body.clientWidth;
				h = document.body.clientHeight;
				
				vis
					.attr("width", w)
					.attr("height", h);
				
				force
					.size([w, h])
					.start();
			}
			
			function increment(obj, idx)
			{
				if (idx in obj.items)
					return obj.items[idx] += 1;
				else
					return obj.items[idx] = 1;
			}
			
			function sum(obj)
			{
				var n = 0;
				
				for (var i in obj)
					n += obj[i];
				
				return n;
			}
			
			function radius(d)
			{
				return 10 + Math.min(sum(d.site.requested_by.items), 30);
			}

			function update()
			{
			  force.start();

			  vis.selectAll("line.link")
				  .data(links)
				.enter().insert("svg:line", "g.node")
				  .attr("class", "link")
				  .attr("x1", function(d) { return d.source.x; })
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });

				var node = vis.selectAll("g.node").data(nodes).enter()
					.append("svg:g")
					.attr("class", "node")
					.on("mouseover", function(d) { d3.select("#info").text(d.site.domain + " (" + sum(d.site.requested_by.items) + ")") })
					.on("mouseout", function(d) { d3.select("#info").text("") })
					.call(force.drag);
				
				node.append("svg:circle")
					.attr("cx", 0)
					.attr("cy", 0)
					.attr("r", function(d) { return radius(d); });
				
				node.append("svg:image")
					.attr("width", 16)
					.attr("height", 16)
					.attr("x", -8)
					.attr("y", -8)
					.attr("xlink:href", function(d) { return "chrome://favicon/" + d.site.protocol + "://" + d.site.domain; });
			}
			
			function main()
			{
				// Update the canvas on resize
				
				resize();

				window.addEventListener('resize', resize, false);

				// Setup the connection for events of newly requested sites
				
				var port = chrome.extension.connect();

				port.onMessage.addListener(function(m) {
					console.log("message", m);

					var is_new = false;

					if (!sites[m.requesting_site.domain]) {
						addSite(m.requesting_site, sites[m.requested_site.domain]);
						is_new = true;
					}
					else {
						is_new = increment(sites[m.requesting_site.domain].requests, m.requested_site.domain) === 1;
					}

					if (!sites[m.requested_site.domain]) {
						addSite(m.requested_site, sites[m.requested_site.domain]);
						is_new = true;
					}
					else {
						is_new = increment(sites[m.requested_site.domain].requested_by, m.requested_site.domain) === 1;
					}

					// only add a new link if one of both sites is new
					if (is_new && !isLinked(m.requested_site.domain, m.requesting_site.domain))
						addLink(m.requesting_site.domain, m.requested_site.domain);
					
					update(); // recalculate!
				});
				
				// Import all $sites data that background.html already has collected.
				
				chrome.extension.sendRequest({'action': 'get_sites'}, function(response) {
					sites = response;

					// Give all received sites a node and initial links
					for (var domain in response)
						addSite(response[domain]);

					// Give all received sites their links
					for (var d in response)
						for (var r in sites[d].requests.items)
							addLink(d, r);

					update();
				});
			}
			
			function test()
			{
				var x = {
					"items": {
						"a": 3
					}
				};
				
				console.assert(increment(x, "a") === 4, "incrementing does not return updated value");
				console.assert(x.items.a === 4, "variable was not incremented");
				
				console.assert(increment(x, "b") === 1, "increment does not return new value of 1");
				console.assert(x.items.b === 1, "variable was not initialized with 1");
			}
			
			main();
		</script>
	</body>
</html>