<!DOCTYPE>
<html>
	<head>
		<title>Wiretap</title>
		<script src="lib/d3/d3.js"></script>
		<script src="lib/d3/d3.geom.js"></script>
		<script src="lib/d3/d3.layout.js"></script>
		<style>

		body {
			margin: 0;
			padding: 0;
		}

		#info {
			position: absolute;
			top: 0;
			right: 0;
		}

		rect {
		  fill: #fff;
		}

		.node {
		  fill: #000;
		}

		.cursor {
		  fill: none;
		  stroke: brown;
		  pointer-events: none;
		}

		.link {
		  stroke: #999;
		}

		    </style>
	</head>
	<body>
		<div id="chart"></div>
		<p id="info"></p>
		<script>
			var w = 960,
				h = 500,
				fill = d3.scale.category20(),
				nodes = [],
				links = [];

			var vis = d3.select("#chart").append("svg:svg");

			vis.append("svg:rect")
				.attr("width", "100%")
				.attr("height", "100%");

			var force = d3.layout.force()
				.distance(60)
				.nodes(nodes)
				.links(links);

			force.on("tick", function() {
			  vis.selectAll("line.link")
				  .attr("x1", function(d) { return d.source.x; })
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });

			  vis.selectAll("image.node")
				  .attr("x", function(d) { return d.x - 8; })
				  .attr("y", function(d) { return d.y - 8; });
			});

			chrome.extension.sendRequest({'action': 'get_sites'}, function($sites) {
				console.log('Received', $sites);

				for (var domain in $sites) {
					var node = {x: 0, y: 0, site: $sites[domain]};

					nodes.push(node);

					$sites[domain].node = node;
				}

				for (var d in $sites) {
					for (var r in $sites[d].requests.items) {
						console.log(r, d);
						links.push({source: $sites[d].node, target: $sites[r].node});
					}
				}

				restart();
			});

			resize();

			window.addEventListener('resize', resize, false);

			function resize() {
				w = document.body.clientWidth;
				h = document.body.clientHeight;

				vis
				  .attr("width", w)
				  .attr("height", h);
				
				force
				  .size([w, h]);
			}

			function restart() {
			  force.start();

			  vis.selectAll("line.link")
				  .data(links)
				.enter().insert("svg:line", "image.node")
				  .attr("class", "link")
				  .attr("x1", function(d) { return d.source.x; })
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });

			  vis.selectAll("image.node")
				  .data(nodes)
				.enter().insert("svg:image")
				  .attr("width", 16)
				  .attr("height", 16)
				  .attr("xlink:href", function(d) { return "chrome://favicon/" + d.site.protocol + "://" + d.site.domain; })
				  .attr("title", function(d) { return d.site.domain; })
				  .attr("class", "node")
				  .attr("x", function(d) { return d.x - 8; })
				  .attr("y", function(d) { return d.y - 8; })
				  .on("mouseover", function (d) { d3.select("#info").text(d.site.domain) })
				  .on("mouseout", function(d) { d3.select("#info").text("") })
				  .call(force.drag);
			}
		</script>
	</body>
</html>