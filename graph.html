<!DOCTYPE>
<html>
	<head>
		<title>Wiretap</title>
		<script src="lib/d3/d3.js"></script>
		<script src="lib/d3/d3.geom.js"></script>
		<script src="lib/d3/d3.layout.js"></script>
		<style>

		body {
			margin: 0;
			padding: 0;
		}

		#info {
			position: absolute;
			top: 0;
			right: 0;
		}

		rect {
		  fill: #fff;
		}

		.node circle {
			stroke: #333;
			fill: #ccc;
		}
		
		.link {
		  stroke: #999;
		}

		    </style>
	</head>
	<body>
		<div id="chart"></div>
		<p id="info"></p>
		<script>
			var w = 960,
				h = 500,
				fill = d3.scale.category20(),
				sites = {},
				nodes = [],
				links = [];

			var vis = d3.select("#chart").append("svg:svg");

			vis.append("svg:rect")
				.attr("width", "100%")
				.attr("height", "100%");

			var force = d3.layout.force()
				.linkDistance(function(l) {
					return Math.max(
						120 - l.target.site.requested_by.items[l.source.site.domain] / sum(l.target.site.requested_by.items) * 100,
						3 + radius(l.source) + radius(l.target)
					)
				})
				//.linkStrength(function(l) { return l.target.site.requested_by.items[l.source.site.domain] / sum(l.target.site.requested_by.items); })
				.charge(-550)
				//
				//.friction(function(d) { return radius(d, 1, 30) / 30 })
				.nodes(nodes)
				.links(links);

			force.on("tick", function() {
				vis.selectAll("line.link")
					.attr("x1", function(d) { return d.source.x; })
					.attr("y1", function(d) { return d.source.y; })
					.attr("x2", function(d) { return d.target.x; })
					.attr("y2", function(d) { return d.target.y; });

				vis.selectAll("g.node")
					.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
				
				vis.selectAll("g.node circle")
					.attr("r", function(d) { return radius(d); });
			});

			chrome.extension.sendRequest({'action': 'get_sites'}, function(response) {
				sites = response;

				// Give all received sites a node and initial links
				for (var domain in response)
					addSite(response[domain]);

				// Give all received sites their links
				for (var d in response)
					for (var r in sites[d].requests.items)
						addLink(d, r);

				restart();
			});
			
			var port = chrome.extension.connect();
			
			port.onMessage.addListener(function(m) {
				console.log("message", m);
				
				var is_new = false;
				
				if (!sites[m.requesting_site.domain]) {
					addSite(m.requesting_site);
					is_new = true;
				}
				else {
					increment(sites[m.requesting_site.domain].requests, m.requested_site.domain);
				}
				
				if (!sites[m.requested_site.domain]) {
					addSite(m.requested_site);
					is_new = true;
				}
				else {
					increment(sites[m.requested_site.domain].requested_by, m.requested_site.domain);
				}
				
				// only add a new link if one of both sites is new
				if (is_new) {
					addLink(m.requesting_site.domain, m.requested_site.domain);
					restart(); // recalculate!
				}
				else {
					force.start();
				}
			});
			
			function addSite(site)
			{
				if (!sites[site.domain])
					sites[site.domain] = site;
				
				else if (sites[site.domain].node)
					return;
				
			 	var node = {x: 0, y: 0, site: sites[site.domain]};
				sites[site.domain].node = node;
				nodes.push(node);
			}
			
			function addLink(requesting_domain, requested_domain)
			{
				links.push({
					source: sites[requesting_domain].node,
					target: sites[requested_domain].node
				});
			}

			resize();

			window.addEventListener('resize', resize, false);

			function resize()
			{
				w = document.body.clientWidth;
				h = document.body.clientHeight;
				
				vis
					.attr("width", w)
					.attr("height", h);
				
				force
					.size([w, h])
					.start();
			}
			
			function increment(obj, idx)
			{
				if (idx in obj)
					++obj.items[idx]; 
				else
					obj.items[idx] = 1;
			}
			
			function sum(obj)
			{
				var n = 0;
				
				for (var i in obj)
					n += obj[i];
				
				return n;
			}
			
			function radius(d)
			{
				return 10 + Math.min(sum(d.site.requested_by.items), 30);
			}

			function restart()
			{
			  force.start();

			  vis.selectAll("line.link")
				  .data(links)
				.enter().insert("svg:line", "svg.node")
				  .attr("class", "link")
				  .attr("x1", function(d) { return d.source.x; })
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });

				var node = vis.selectAll("g.node").data(nodes).enter()
					.append("svg:g")
					.attr("class", "node")
					.on("mouseover", function(d) { d3.select("#info").text(d.site.domain + " (" + sum(d.site.requested_by.items) + ")") })
					.on("mouseout", function(d) { d3.select("#info").text("") })
					.call(force.drag);
				
				node.append("svg:circle")
					.attr("cx", 0)
					.attr("cy", 0)
					.attr("r", function(d) { return radius(d); });
				
				node.append("svg:image")
					.attr("width", 16)
					.attr("height", 16)
					.attr("x", -8)
					.attr("y", -8)
					.attr("xlink:href", function(d) { return "chrome://favicon/" + d.site.protocol + "://" + d.site.domain; });
			}
		</script>
	</body>
</html>